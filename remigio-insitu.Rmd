---
title: "Remigio-Capstone-InSitu"
author: "R. Remigio"
date: "June 23, 2016"
output: html_document
---


```{r declare-your-libraries, echo=FALSE}
library(dplyr)
library(raster)
library(rhdf5)
library(rgdal)
library(neonAOP)
library(reshape2)
library(ggplot2)

options(stringsAsFactors = FALSE)

```

## Import D17-SOAP Field Data

```{r import-insitu}

## read in file
insitu.SOAP<-read.csv("/Users/R-Files/Documents/data/NEONDI-2016/NEONdata/D17-California/SOAP/2013/insitu/veg-structure/D17_2013_SOAP_vegStr.csv")

## visualize structure
str(insitu.SOAP)

#summarize
summary(insitu.SOAP)


```


## Exploratory Analysis: Subset variables of interest and identify data type (Cat & Cont)

```{r select-variables}

#  selected potential predictors of interest at SOAP 2013

# plotid, taxonid, scientificname, dbh, dbhheight, basalCanopyDiam, Maximum canopy diameter, stemheight
# canopyform, livingcanopy,  inplotcanopy

# subset dataframe-- make it not dirty
insitu.SOAP<-subset(insitu.SOAP, select=c(plotid, easting, northing, taxonid, scientificname, dbh, dbhheight, basalcanopydiam, maxcanopydiam, stemheight, canopyform, livingcanopy,  inplotcanopy))

## subset categorical variables
SOAP.cat<-subset(insitu.SOAP, select=c(plotid, taxonid, scientificname, canopyform))

## subset continuous variables
SOAP.cont<- subset(insitu.SOAP, select=c(dbh, dbhheight, basalcanopydiam, maxcanopydiam, stemheight, livingcanopy, inplotcanopy))

```


## Exploratory Analysis for SOAP- Frequency Categorical Statistics
```{r summary-statistics-cateogrical}

## frequency summaries by:

# plotid
SOAP.cat %>%
  group_by(plotid) %>%
  summarise (n = n()) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 1), "%"))

# dominant(?) plant type

SOAP.cat %>%
  group_by(scientificname) %>%
  summarise (n = n()) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 1), "%"))

# canopyform

SOAP.cat %>%
  group_by(canopyform) %>%
  summarise (n = n()) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 1), "%"))


```

## Exploratory Analysis for SOAP- Summary Continuous Statistics
```{r summary-statistics-continuous}
## Continuous variable summaries- Min/Max, Quants
summary(SOAP.cont)

## Continuous variable summaries- Std Devs
sapply(SOAP.cont, sd, na.rm=TRUE)

# matrix scatterplot
plot(SOAP.cont)

#side by side boxplots
boxplot(SOAP.cont, las=2)

```

## Exploratory Analysis for SOAP by Sampling Plots

```{r exploratory-analysis-by-plots}
## by species types by PlotID

xtabs(~plotid+scientificname, data=SOAP.cat)


## aggregate summary stats 
#  Re-instate PlotID

SOAP.cont$plotid<-insitu.SOAP$plotid

# group by
melted <- melt(SOAP.cont, id.vars=c("plotid"))

SOAP.aggregate<-summarise(group_by(melted, plotid, variable),
          mean=mean(value, na.rm=TRUE), sd=sd(value, na.rm=TRUE), 
          min=min(value, na.rm=TRUE), max=max(value, na.rm=TRUE))
 
SOAP.aggregate

## WHOA-- That's a big spicy meatball!
## Break it down by plot again-- this time stratify by parameter

#overside columnn width restriction
options(dplyr.width = Inf)

# dbh
 insitu_dbh <- SOAP.cont %>%
   group_by(plotid) %>%
   summarise(dbh.min = min(dbh, na.rm=TRUE), dbh.max = max(dbh, na.rm=TRUE), dbh.mean=mean(dbh, na.rm=TRUE), dbh.median=median(dbh, na.rm=TRUE),dbh.sd=sd(dbh, na.rm=TRUE))

 insitu_dbh             

## functionalization might be best here...but for now 
 ## JV scripting

 
  # dbhheight
 insitu_dbhheight <- SOAP.cont %>%
   group_by(plotid) %>%
   summarise(dbhheight.min = min(dbhheight, na.rm=TRUE), dbhheight.max = max(dbhheight, na.rm=TRUE), dbhheight.mean=mean(dbhheight, na.rm=TRUE), dbhheight.median=median(dbhheight, na.rm=TRUE),dbhheight.sd=sd(dbhheight, na.rm=TRUE))
 
 insitu_dbhheight
 
 # basalcanopydiam
 insitu_basalcanopydiam <- SOAP.cont %>%
   group_by(plotid) %>%
   summarise(basalcanopydiam.min = min(basalcanopydiam, na.rm=TRUE), basalcanopydiam.max = max(basalcanopydiam, na.rm=TRUE), basalcanopydiam.mean=mean(basalcanopydiam, na.rm=TRUE), basalcanopydiam.median=median(basalcanopydiam, na.rm=TRUE),basalcanopydiam.sd=sd(basalcanopydiam, na.rm=TRUE))
 
 insitu_basalcanopydiam
 
 # maxcanopydiam
 insitu_maxcanopydiam <- SOAP.cont %>%
   group_by(plotid) %>%
   summarise(maxcanopydiam.min = min(maxcanopydiam, na.rm=TRUE), maxcanopydiam.max = max(maxcanopydiam, na.rm=TRUE), maxcanopydiam.mean=mean(maxcanopydiam, na.rm=TRUE), maxcanopydiam.median=median(maxcanopydiam, na.rm=TRUE),maxcanopydiam.sd=sd(maxcanopydiam, na.rm=TRUE))
 
 insitu_maxcanopydiam
 
  # stemheight
 insitu_stemheight <- SOAP.cont %>%
   group_by(plotid) %>%
   summarise(stemheight.min = min(stemheight, na.rm=TRUE), stemheight.max = max(stemheight, na.rm=TRUE), stemheight.mean=mean(stemheight, na.rm=TRUE), stemheight.median=median(stemheight, na.rm=TRUE),stemheight.sd=sd(stemheight, na.rm=TRUE))
 
 insitu_stemheight
 
  # livingcanopy
 insitu_livingcanopy <- SOAP.cont %>%
   group_by(plotid) %>%
   summarise(livingcanopy.min = min(livingcanopy, na.rm=TRUE), livingcanopy.max = max(livingcanopy, na.rm=TRUE), livingcanopy.mean=mean(livingcanopy, na.rm=TRUE), livingcanopy.median=median(livingcanopy, na.rm=TRUE),livingcanopy.sd=sd(livingcanopy, na.rm=TRUE))
  
 insitu_livingcanopy
 
   # inplotcanopy
 insitu_inplotcanopy <- SOAP.cont %>%
   group_by(plotid) %>%
   summarise(inplotcanopy.min = min(inplotcanopy, na.rm=TRUE), inplotcanopy.max = max(inplotcanopy, na.rm=TRUE), inplotcanopy.mean=mean(inplotcanopy, na.rm=TRUE), inplotcanopy.median=median(inplotcanopy, na.rm=TRUE),inplotcanopy.sd=sd(inplotcanopy, na.rm=TRUE))
 
 insitu_inplotcanopy 
 
```

## Let's Extract Some Vegetation Indices for SOAP

```{r extract-L3-NDVI-SOAP-site}
## import NDVI
SOAP.ndvi <- raster("../NEONdata/D17-California/SOAP/2013/spectrometer/veg_index/SOAP_NDVI.tif")
SOAP.ndvi

##visualize distribution

hist(SOAP.ndvi, main="NDVI for SOAP Site")

# visualize raster
plot(SOAP.ndvi, main="NDVI for SOAP Site")

```

```{r import-plot-centroids}
## read in plot centroids
SOAP_plots <- readOGR("../NEONdata/D17-California/SOAP/vector_data/",
                      "SOAP_centroids")

# Overlay the centroid points and the stem locations on the NDVI plot
plot(SOAP.ndvi,
     main="SOAP Plot Locations \n(N=18)",
     col=gray.colors(100, start=.3, end=.9))

# pch 0 = square
plot(SOAP_plots,
     pch = 0,
     cex = 2,
     col = 4,
     add=TRUE)

```

```{r extract-ndvi-data-2m-buff}
# Insitu sampling took place within 40m x 40m square plots, so we use a 20m radius.
# Note that below will return a dataframe containing the max height
# calculated from all pixels in the buffer for each plot (NEON Website)

## we will use these values to populate in-situ data set

NDVI.max <- extract(SOAP.ndvi,
                    SOAP_plots,
                    buffer = 20,
                    fun=(max),
                    sp=TRUE,
                    stringsAsFactors=FALSE)


# NDVI distribution visualization for each plot
# created histograms for all 14 plots of data

cent_ovrList <- extract(SOAP.ndvi,SOAP_plots,buffer = 20)

for (i in 1:14) {
  hist(cent_ovrList[[i]], main=(paste("plot",i)))
  }

```

## Extract descriptive stats from Insitu Data

```{r combine-centroid-data-and-NDVI-data}
# import the centroid data and the vegetation structure data

## Call out insitu.SOAP dataframe
## refamilize with PlotIDs within SOAP
unique(insitu.SOAP$plotid)

# find the max parameter values for each in situ plot
insitu.max <- insitu.SOAP %>%
  group_by(plotid) %>%
  summarise(max.dbh = max(dbh, na.rm=TRUE), max.dbhheight=max(dbhheight, na.rm=TRUE),
            max.basalcanopydiam= max(basalcanopydiam, na.rm=TRUE), 
            max.maxcanopydiam=max(maxcanopydiam), 
            max.stemheight=max(stemheight, na.rm=TRUE),
            max.livingcanopy=max(livingcanopy, na.rm=TRUE),
            max.inplotcanopy= max(inplotcanopy, na.rm=TRUE))

```

```{r merge-data-finally}
## merge data into data frame, can use approach to create spatial object
## But purposes of capstone will conduct "boring regression analysis"
## merge grouped data (insitu.max) and extracted NDVI (NDVI.max) 
## using plotid to merge

## first must append  NDVI.max file with SOAP

#create data frame for NDVI.max

NDVI.max.df<-NDVI.max@data

# add SOAP prefix to IDs

NDVI.max.df$plot.id<- "SOAP"
NDVI.max.df$plot.id<-(sapply(NDVI.max.df$plot.id, paste0, NDVI.max.df$ID))[,1]

# rename column

colnames(NDVI.max.df)[colnames(NDVI.max.df) == 'SOAP'] <- 'Plot.ID'

SOAP.grand<-merge(NDVI.max.df, insitu.max, 
      by.x = 'plot.id',
      by.y = 'plotid')

# F* Yes

```


```{r regression-playground-aggregate}

## Reponse variables: dbh, basalcanopydiam, maxcanopydiam, stemheight, livingcanopy, inplotcanopy

## Predictor variable: SOAP_NDVI



```

